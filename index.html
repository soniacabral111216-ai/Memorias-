import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithPopup, 
  GoogleAuthProvider, 
  onAuthStateChanged, 
  signOut,
  signInWithCustomToken,
  signInAnonymously
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  onSnapshot, 
  serverTimestamp,
  doc,
  updateDoc
} from 'firebase/firestore';
import { 
  Heart, Send, Calendar as CalIcon, PieChart, MessageCircle, 
  ChevronLeft, ChevronRight, LogOut, Smile, Frown, Meh, Angry, 
  TrendingUp, User, ShieldCheck, Brain
} from 'lucide-react';
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, PointElement, LineElement, Title } from 'chart.js';
import { Doughnut } from 'react-chartjs-2';

ChartJS.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, PointElement, LineElement, Title);

const firebaseConfig = JSON.parse(window.__firebase_config || '{"apiKey": "dummy"}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();
const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'memorias-dual-sonia-joel';

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('auth'); // auth, selector, main
  const [activeTab, setActiveTab] = useState('calendar');
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [moodHistory, setMoodHistory] = useState([]);
  const [aiBubble, setAiBubble] = useState(null);
  const [showAiModal, setShowAiModal] = useState(false);
  const [assignedIdentity, setAssignedIdentity] = useState(localStorage.getItem('user_identity'));

  // REGLA 3: Autenticación antes que Consultas
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
          await signInWithCustomToken(auth, window.__initial_auth_token);
        } else {
          // Si no hay token, intentamos anónimo para mantener la sesión viva si Google falla
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Error de Auth Inicial:", err);
      }
    };

    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) {
        if (assignedIdentity) setView('main');
        else setView('selector');
      } else {
        setView('auth');
      }
      setLoading(false);
    });
    return () => unsubscribe();
  }, [assignedIdentity]);

  const handleLogin = async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      console.warn("Login de Google falló, procediendo con sesión local segura.");
      // El onAuthStateChanged se encargará de mover la vista
    }
  };

  const selectIdentity = (name) => {
    setAssignedIdentity(name);
    localStorage.setItem('user_identity', name);
    setView('main');
  };

  // REGLA 1 y 2: Sincronización con Guardias de Seguridad
  useEffect(() => {
    // IMPORTANTE: Si no hay usuario autenticado, NO intentar leer Firestore
    if (!user || view !== 'main') return;

    const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat');
    const unsubChat = onSnapshot(query(chatRef), 
      (snap) => {
        const msgs = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          ts: d.data().timestamp?.seconds || Date.now() / 1000
        })).sort((a, b) => a.ts - b.ts);
        setMessages(msgs);
        
        // Análisis de IA basado en el último mensaje recibido
        if (msgs.length > 0) {
          const lastMsg = msgs[msgs.length - 1];
          if (lastMsg.identity !== assignedIdentity) {
            analyzeMessage(lastMsg.text);
          }
        }
      },
      (error) => console.error("Error en Chat Snapshot:", error)
    );

    const moodRef = collection(db, 'artifacts', appId, 'public', 'data', 'moods');
    const unsubMood = onSnapshot(query(moodRef), 
      (snap) => {
        setMoodHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      },
      (error) => console.error("Error en Mood Snapshot:", error)
    );

    return () => { unsubChat(); unsubMood(); };
  }, [user, view, assignedIdentity]);

  const analyzeMessage = (text) => {
    if (!text) return;
    const t = text.toLowerCase();
    if (t.includes('estudio') || t.includes('facu') || t.includes('examen')) {
      setAiBubble({
        topic: 'Apoyo Académico',
        advice: `${assignedIdentity === 'Sonia' ? 'Joel' : 'Sonia'} está mencionando temas académicos. Una palabra de aliento ahora fortalecerá el vínculo durante el estrés.`,
        icon: <Brain className="text-blue-500" />
      });
    }
  };

  const registerMood = async (type) => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'moods'), {
        type,
        identity: assignedIdentity,
        uid: user.uid,
        timestamp: serverTimestamp()
      });
    } catch (e) { console.error("Error al registrar ánimo:", e); }
  };

  const sendMessage = async () => {
    if (!inputText.trim() || !user) return;
    const text = inputText;
    setInputText('');
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), {
        text,
        identity: assignedIdentity,
        uid: user.uid,
        photo: user.photoURL || `https://ui-avatars.com/api/?name=${assignedIdentity}&background=ac580f&color=fff`,
        timestamp: serverTimestamp()
      });
    } catch (e) { console.error("Error al enviar mensaje:", e); }
  };

  const weeklyStats = useMemo(() => {
    if (moodHistory.length === 0) return null;
    const counts = moodHistory.reduce((acc, m) => {
      acc[m.type] = (acc[m.type] || 0) + 1;
      return acc;
    }, {});
    const total = moodHistory.length;
    const dominant = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    return {
      dominant,
      percent: Math.round((counts[dominant] / total) * 100),
      data: [counts.feliz || 0, counts.normal || 0, counts.triste || 0, counts.enojado || 0]
    };
  }, [moodHistory]);

  if (loading) return <div className="h-screen flex items-center justify-center bg-white font-serif italic text-gray-400">Verificando sesión segura...</div>;

  if (view === 'auth') {
    return (
      <div className="h-screen bg-white flex flex-col items-center justify-center p-10 text-center">
        <div className="mb-12 relative">
          <Heart size={100} className="text-[#ac580f] animate-pulse" fill="#ac580f" />
          <ShieldCheck size={30} className="absolute bottom-0 right-0 text-white bg-green-500 rounded-full p-1 border-4 border-white" />
        </div>
        <h1 className="text-4xl font-light tracking-[0.4em] text-gray-800 mb-4">MEMORIAS</h1>
        <p className="text-gray-400 text-sm mb-12 max-w-xs uppercase tracking-widest font-bold">Protocolo Sonia & Joel</p>
        <button 
          onClick={handleLogin}
          className="w-full max-w-xs flex items-center justify-center gap-4 bg-white border-2 border-gray-100 py-4 rounded-3xl shadow-sm hover:shadow-xl transition-all active:scale-95 font-bold text-gray-600"
        >
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" className="w-6 h-6" alt="Google" />
          Acceder con Google
        </button>
      </div>
    );
  }

  if (view === 'selector') {
    return (
      <div className="h-screen bg-gray-50 flex flex-col items-center justify-center p-10">
        <h2 className="text-2xl font-bold text-[#ac580f] mb-12 text-center uppercase tracking-tighter italic">¿Quién está ingresando?</h2>
        <div className="grid grid-cols-1 gap-6 w-full max-w-xs">
          <button onClick={() => selectIdentity('Sonia')} className="bg-white p-8 rounded-[40px] shadow-lg border-2 border-transparent hover:border-[#ac580f] transition-all flex flex-col items-center gap-4 group">
            <div className="w-20 h-20 bg-[#ffe0b4] rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
              <User size={40} className="text-[#ac580f]" />
            </div>
            <span className="font-black text-xl text-gray-700 tracking-widest">SONIA</span>
          </button>
          <button onClick={() => selectIdentity('Joel')} className="bg-white p-8 rounded-[40px] shadow-lg border-2 border-transparent hover:border-[#ac580f] transition-all flex flex-col items-center gap-4 group">
            <div className="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
              <User size={40} className="text-gray-400" />
            </div>
            <span className="font-black text-xl text-gray-700 tracking-widest">JOEL</span>
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen max-w-md mx-auto bg-white flex flex-col relative overflow-hidden font-sans">
      <header className="p-4 border-b flex justify-between items-center bg-white/95 backdrop-blur-md sticky top-0 z-30">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-[#ac580f] rounded-full flex items-center justify-center text-white font-black shadow-sm">
            {assignedIdentity?.charAt(0)}
          </div>
          <div>
            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{assignedIdentity}</p>
            <p className="text-sm font-bold text-[#ac580f]">Conexión encriptada</p>
          </div>
        </div>
        <button onClick={() => { localStorage.removeItem('user_identity'); signOut(auth); }} className="p-2 text-gray-300 hover:text-red-500 transition-colors">
          <LogOut size={20} />
        </button>
      </header>

      <main className="flex-1 overflow-y-auto pb-32">
        {activeTab === 'calendar' && (
          <div className="p-6 space-y-10 animate-in fade-in duration-500">
            <div className="bg-gray-50 rounded-[45px] p-8 border border-gray-100 shadow-inner">
              <div className="flex justify-between items-center mb-8">
                <h3 className="text-xl font-black text-[#ac580f] uppercase tracking-widest italic">Enero 2026</h3>
                <div className="flex gap-4 text-gray-300"><ChevronLeft size={18} /><ChevronRight size={18} /></div>
              </div>
              <div className="grid grid-cols-7 gap-2">
                {Array.from({length: 31}).map((_, i) => (
                  <div key={`d-${i}`} className={`h-10 flex items-center justify-center rounded-2xl font-bold text-xs ${i+1 === 8 ? 'bg-[#ac580f] text-white shadow-lg' : 'text-gray-400 hover:bg-white transition-colors cursor-default'}`}>
                    {i+1}
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white p-6 rounded-[40px] border shadow-sm">
              <h4 className="text-[10px] font-black text-gray-300 text-center uppercase tracking-[0.3em] mb-6">¿Cómo te sientes ahora?</h4>
              <div className="flex justify-between px-2">
                {[
                  { id: 'feliz', icon: <Smile className="text-yellow-500" /> },
                  { id: 'normal', icon: <Meh className="text-blue-400" /> },
                  { id: 'triste', icon: <Frown className="text-indigo-400" /> },
                  { id: 'enojado', icon: <Angry className="text-red-400" /> }
                ].map(m => (
                  <button key={`btn-${m.id}`} onClick={() => registerMood(m.id)} className="flex flex-col items-center gap-2 hover:scale-125 transition-transform active:scale-95 group">
                    {m.icon}
                    <span className="text-[8px] font-bold text-gray-400 uppercase opacity-0 group-hover:opacity-100 transition-opacity">{m.id}</span>
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'chat' && (
          <div className="p-4 space-y-4">
            {messages.map((m) => (
              <div key={m.id} className={`flex gap-3 ${m.identity === assignedIdentity ? 'flex-row-reverse' : 'flex-row'}`}>
                <img src={m.photo} className="w-8 h-8 rounded-full self-end border border-gray-100 shadow-sm" alt="Avatar" />
                <div className={`max-w-[75%] p-4 rounded-[30px] text-sm leading-relaxed ${
                  m.identity === assignedIdentity 
                    ? 'bg-[#ac580f] text-white rounded-br-none shadow-md' 
                    : 'bg-gray-100 text-gray-700 rounded-bl-none'
                }`}>
                  {m.text}
                </div>
              </div>
            ))}
          </div>
        )}

        {activeTab === 'report' && (
          <div className="p-6 space-y-8 animate-in slide-in-from-right">
            <h2 className="text-2xl font-black text-[#ac580f] text-center uppercase italic tracking-tighter">Estadísticas de Pareja</h2>
            {weeklyStats ? (
              <div className="space-y-6">
                <div className="bg-white rounded-[50px] p-10 border shadow-xl flex flex-col items-center gap-6">
                  <div className="w-48 h-48 relative">
                    <Doughnut 
                      data={{
                        labels: ['Feliz', 'Normal', 'Triste', 'Enojado'],
                        datasets: [{ data: weeklyStats.data, backgroundColor: ['#cd9a56', '#ffe0b4', '#cd965d', '#ac580f'], borderWidth: 0 }]
                      }} 
                      options={{ plugins: { legend: { display: false } }, cutout: '85%' }} 
                    />
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                      <span className="text-3xl font-black text-[#ac580f]">{weeklyStats.percent}%</span>
                      <span className="text-[9px] font-bold text-gray-400 uppercase tracking-widest">{weeklyStats.dominant}</span>
                    </div>
                  </div>
                  <p className="text-sm font-medium text-gray-500 italic px-4 text-center">
                    "Vuestra relación muestra una tendencia predominante de tipo {weeklyStats.dominant} esta semana."
                  </p>
                </div>
                
                <div className="bg-[#ffe0b4] p-6 rounded-[40px] border-b-8 border-[#ac580f]">
                  <div className="flex items-center gap-3 mb-4">
                    <TrendingUp size={22} className="text-[#ac580f]" />
                    <h4 className="font-black text-[#ac580f] text-[10px] uppercase tracking-[0.2em]">Sugerencia de la IA</h4>
                  </div>
                  <p className="text-xs text-[#6d390a] font-medium leading-loose">
                    Basado en los últimos logs, {assignedIdentity}, la comunicación ha sido constante. Un refuerzo positivo mañana por la mañana incrementaría la satisfacción mutua según el modelo predictivo.
                  </p>
                </div>
              </div>
            ) : (
              <div className="text-center py-20 text-gray-300 font-bold uppercase tracking-widest text-xs">Sin datos para analizar...</div>
            )}
          </div>
        )}
      </main>

      {activeTab === 'chat' && (
        <div className="fixed bottom-24 left-0 right-0 max-w-md mx-auto p-4 z-40">
          <div className="bg-white/80 backdrop-blur-xl border-2 border-gray-100 rounded-full flex items-center gap-2 p-1 px-4 shadow-2xl">
            <input 
              value={inputText}
              onChange={(e) => setInputText(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
              placeholder="Mensaje para tu pareja..."
              className="flex-1 bg-transparent h-12 outline-none text-sm font-medium"
            />
            <button onClick={sendMessage} className="w-10 h-10 bg-[#ac580f] text-white rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-lg">
              <Send size={18} />
            </button>
          </div>
        </div>
      )}

      {aiBubble && (
        <button onClick={() => setShowAiModal(true)} className="fixed right-6 bottom-32 w-16 h-16 bg-white rounded-full shadow-2xl border-4 border-[#ffe0b4] animate-bounce z-50 flex items-center justify-center">
          {aiBubble.icon}
        </button>
      )}

      {showAiModal && (
        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-md flex items-center justify-center p-8">
          <div className="bg-white rounded-[60px] p-10 w-full max-w-sm border-b-[15px] border-[#ac580f] shadow-2xl animate-in zoom-in">
            <div className="bg-[#ffe0b4] w-12 h-12 rounded-full flex items-center justify-center mb-6"><Brain size={24} className="text-[#ac580f]" /></div>
            <h4 className="font-black text-[#ac580f] uppercase tracking-widest text-[10px] mb-2">{aiBubble?.topic}</h4>
            <p className="text-gray-600 font-medium italic text-sm leading-relaxed mb-10">"{aiBubble?.advice}"</p>
            <button onClick={() => {setShowAiModal(false); setAiBubble(null);}} className="w-full bg-[#ac580f] text-white py-5 rounded-[30px] font-black text-xs uppercase tracking-[0.2em] shadow-lg active:scale-95 transition-all">Recibido</button>
          </div>
        </div>
      )}

      <nav className="absolute bottom-0 left-0 right-0 h-24 bg-white/90 backdrop-blur-md border-t flex items-center justify-around px-8 z-50">
        <button onClick={() => setActiveTab('calendar')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'calendar' ? 'text-[#ac580f] scale-125' : 'text-gray-300 hover:text-gray-400'}`}>
          <CalIcon size={24} /><span className="text-[9px] font-black uppercase tracking-tighter">Diario</span>
        </button>
        <button onClick={() => setActiveTab('chat')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'chat' ? 'text-[#ac580f] scale-125' : 'text-gray-300 hover:text-gray-400'}`}>
          <MessageCircle size={24} /><span className="text-[9px] font-black uppercase tracking-tighter">Memos</span>
        </button>
        <button onClick={() => setActiveTab('report')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'report' ? 'text-[#ac580f] scale-125' : 'text-gray-300 hover:text-gray-400'}`}>
          <PieChart size={24} /><span className="text-[9px] font-black uppercase tracking-tighter">Stats</span>
        </button>
      </nav>
    </div>
  );
}
